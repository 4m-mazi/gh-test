name: publish crates
on:
  push:
    branches: ["**"]
  pull_request:
  workflow_call:

permissions: {}

jobs:
  set-up:
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      dry-run: ${{ steps.set-dry-run.outputs.dry-run }}
    steps:
      - id: set-dry-run
        env:
          DRY_RUN: ${{ github.workflow == 'publish crates' }}
        run: echo "dry-run=$DRY_RUN" >> $GITHUB_OUTPUT
  publish:
    if: ${{ !( github.workflow == 'crates publish' && startsWith(github.event.head_commit.message, 'release:') && github.event.head_commit.author.name == 'github-actions[bot]' ) }}
    needs: ["set-up"]
    name: "${{ needs.set-up.outputs.dry-run && 'DRY-RUN' || '' }} publish"
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - uses: katyo/publish-crates@33e1d18666cdfacf9f6c3547194d2c1d39cbf849 # v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          dry-run: ${{ true || needs.set-up.outputs.dry-run }}
          ignore-unpublished-changes: true
